<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ClariTex Pro - Search & Replace</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Segoe+UI&family=Cairo:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --ms-blue: #0078D4; --ms-bg: #FAF9F8; }
        body { font-family: 'Segoe UI', 'Cairo', sans-serif; background-color: var(--ms-bg); }
        .office-btn:active { transform: scale(0.98); }
        .log-item { font-size: 10px; border-bottom: 1px solid #eee; padding: 2px 0; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 3px; }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden p-3 box-border">

    <!-- Header -->
    <header class="flex items-center justify-between pb-3 border-b border-gray-200 mb-3 shrink-0">
        <div class="flex items-center gap-2 select-none">
            <div class="text-lg font-bold text-[#201F1E]">
                <span style="color: var(--ms-blue);">Clari</span>Tex <span class="text-xs font-normal text-gray-500">Find&Replace</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col gap-3 overflow-hidden">
        
        <!-- Info Card -->
        <div class="bg-blue-50 border border-blue-100 p-3 rounded text-xs text-blue-800 leading-5">
            <strong>وضع الاستبدال الموضعي:</strong>
            سيقوم النظام بالبحث عن معادلات LaTeX (مثل $\alpha$) داخل المستند واستبدالها في مكانها بدقة، مما يحافظ على تنسيق باقي المستند 100%.
        </div>

        <!-- Detected Equations List (Preview of what will be replaced) -->
        <div class="flex-1 flex flex-col bg-white border border-gray-300 rounded shadow-sm overflow-hidden">
            <div class="bg-gray-50 px-3 py-2 border-b flex justify-between items-center shrink-0">
                <span class="text-xs font-bold text-gray-600">المعادلات المكتشفة</span>
                <span id="count-badge" class="bg-gray-200 text-gray-700 px-1.5 rounded text-[10px]">0</span>
            </div>
            <div id="log-area" class="flex-1 p-2 overflow-y-auto ltr-content font-mono text-xs text-gray-600">
                <div class="text-center text-gray-400 mt-4 italic">اضغط "فحص المستند" للبدء...</div>
            </div>
        </div>

        <!-- Actions -->
        <div class="grid grid-cols-2 gap-2 shrink-0">
            <!-- Step 1: Scan -->
            <button onclick="scanDocument()" class="office-btn bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 py-2 rounded text-sm font-semibold flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                1. فحص المستند
            </button>
            
            <!-- Step 2: Replace -->
            <button id="btn-replace" onclick="executeSearchAndReplace()" disabled class="office-btn bg-[#0078D4] hover:bg-[#0062AD] disabled:bg-gray-300 disabled:text-gray-500 text-white py-2 rounded text-sm font-semibold flex items-center justify-center gap-2 shadow-sm transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                2. استبدال الكل
            </button>
        </div>

        <div id="status-bar" class="text-center text-xs h-4 text-green-600 transition-opacity opacity-0 font-medium"></div>
    </main>

    <script>
        Office.onReady((info) => {
            if (info.host === Office.HostType.Word) {
                console.log("Ready");
            }
        });

        // --- Global State ---
        let uniqueEquations = []; // To store found patterns

        // --- 1. Symbol Dictionary (Expanded) ---
        const symbolMap = {
            'alpha': 'α', 'beta': 'β', 'gamma': 'γ', 'delta': 'δ', 'epsilon': 'ε', 'zeta': 'ζ', 'eta': 'η', 'theta': 'θ', 
            'iota': 'ι', 'kappa': 'κ', 'lambda': 'λ', 'mu': 'μ', 'nu': 'ν', 'xi': 'ξ', 'omicron': 'ο', 'pi': 'π', 
            'rho': 'ρ', 'sigma': 'σ', 'tau': 'τ', 'upsilon': 'υ', 'phi': 'φ', 'chi': 'χ', 'psi': 'ψ', 'omega': 'ω',
            'Delta': 'Δ', 'Gamma': 'Γ', 'Lambda': 'Λ', 'Omega': 'Ω', 'Phi': 'Φ', 'Pi': 'Π', 'Sigma': 'Σ', 'Theta': 'Θ',
            'times': '×', 'cdot': '·', 'div': '÷', 'pm': '±', 'approx': '≈', 'neq': '≠', 'le': '≤', 'ge': '≥', 
            'infty': '∞', 'rightarrow': '→', 'leftarrow': '←', 'leftrightarrow': '↔', 'Rightarrow': '⇒',
            'deg': '°', 'circ': '°', 'angle': '∠', 'nabla': '∇', 'partial': '∂', 'sum': '∑', 'prod': '∏', 'int': '∫',
            'in': '∈', 'notin': '∉', 'subset': '⊂', 'subseteq': '⊆', 'cup': '∪', 'cap': '∩', 'empty': '∅'
        };
        const superMap = { '0':'⁰','1':'¹','2':'²','3':'³','4':'⁴','5':'⁵','6':'⁶','7':'⁷','8':'⁸','9':'⁹','+':'⁺','-':'⁻','=':'⁼','(':'⁽',')':'⁾','n':'ⁿ','i':'ⁱ','x':'ˣ' };
        const subMap = { '0':'₀','1':'₁','2':'₂','3':'₃','4':'₄','5':'₅','6':'₆','7':'₇','8':'₈','9':'₉','+':'₊','-':'₋','=':'₌','(':'₍',')':'₎','x':'ₓ','n':'ₙ' };

        // --- 2. Conversion Logic ---
        function convertMathToUnicode(latex) {
            let s = latex;
            s = s.replace(/\\text\{([^}]+)\}/g, '$1'); 
            s = s.replace(/\\mathrm\{([^}]+)\}/g, '$1');
            s = s.replace(/\\frac\{([^}]+)\}\{([^}]+)\}/g, '($1/$2)');
            s = s.replace(/\\sqrt\{([^}]+)\}/g, '√($1)');
            s = s.replace(/\^\{\\circ\}/g, '°').replace(/\^\\circ/g, '°');

            for (const [name, char] of Object.entries(symbolMap)) {
                s = s.replace(new RegExp('\\\\' + name + '(?![a-zA-Z])', 'g'), char);
            }
            s = s.replace(/\^\{([^{}]+)\}/g, (_, g) => mapChars(g, superMap));
            s = s.replace(/\^([a-zA-Z0-9])/g, (_, g) => mapChars(g, superMap));
            s = s.replace(/_\{([^{}]+)\}/g, (_, g) => mapChars(g, subMap));
            s = s.replace(/_([a-zA-Z0-9])/g, (_, g) => mapChars(g, subMap));
            s = s.replace(/\\/g, '');
            return s;
        }

        function mapChars(str, map) { return str.split('').map(c => map[c] || c).join(''); }

        // --- 3. Word Interaction: SCAN ---
        async function scanDocument() {
            try {
                await Word.run(async (context) => {
                    // Get body text to analyze patterns first
                    const body = context.document.body;
                    body.load("text");
                    await context.sync();

                    const text = body.text;
                    
                    // Regex to find all $...$ or \[...\] patterns
                    // Using Set to store unique equations only
                    const matches = new Set();
                    const regex = /(\$[^$]+\$|\\\[[\s\S]*?\\\])/g;
                    let match;
                    while ((match = regex.exec(text)) !== null) {
                        matches.add(match[0]);
                    }

                    // Convert to Array and Sort by Length DESCENDING
                    // Important: Replace longest equations first to avoid partial matches
                    uniqueEquations = Array.from(matches).sort((a, b) => b.length - a.length);

                    updateUI(uniqueEquations);
                    
                    if (uniqueEquations.length > 0) {
                        showStatus(`تم العثور على ${uniqueEquations.length} نموذج معادلة`, "text-blue-600");
                        document.getElementById('btn-replace').disabled = false;
                    } else {
                        showStatus("لم يتم العثور على صيغ LaTeX", "text-orange-500");
                    }
                });
            } catch (error) {
                console.error(error);
                if (!window.Office) {
                    // Mock for testing without Word
                    uniqueEquations = ['$\\alpha + \\beta$', '$\\alpha$'];
                    updateUI(uniqueEquations);
                    document.getElementById('btn-replace').disabled = false;
                }
            }
        }

        function updateUI(equations) {
            const list = document.getElementById('log-area');
            const badge = document.getElementById('count-badge');
            list.innerHTML = '';
            badge.textContent = equations.length;

            equations.forEach(eq => {
                const converted = convertMathToUnicode(eq.replace(/^\\\[|\\\]$|^\$|\$$/g, ''));
                const div = document.createElement('div');
                div.className = 'log-item flex justify-between';
                div.innerHTML = `<span class="text-red-500 truncate w-1/2" title="${eq}">${eq}</span> 
                                 <span class="text-green-600 truncate w-1/2 text-left" dir="ltr">→ ${converted}</span>`;
                list.appendChild(div);
            });
        }

        // --- 4. Word Interaction: EXECUTE REPLACE ---
        async function executeSearchAndReplace() {
            if (uniqueEquations.length === 0) return;

            showStatus("جاري الاستبدال... يرجى الانتظار", "text-blue-600");

            try {
                await Word.run(async (context) => {
                    const body = context.document.body;
                    
                    // Iterate through each unique equation found
                    for (const originalText of uniqueEquations) {
                        
                        // 1. Search for this exact string in the doc
                        // matchWildcards: false ensures '$' is treated literally
                        const searchResults = body.search(originalText, { matchCase: true, matchWildcards: false });
                        context.load(searchResults, 'items');
                        await context.sync();

                        // 2. Prepare the clean replacement
                        const cleanMath = originalText.replace(/^\\\[|\\\]$|^\$|\$$/g, '');
                        const newText = convertMathToUnicode(cleanMath);

                        // 3. Replace all instances found
                        for (let i = 0; i < searchResults.items.length; i++) {
                            // Insert as HTML to support rich chars better, or insertText for plain unicode
                            // insertText is safer for formatting preservation if we only have unicode chars
                            searchResults.items[i].insertText(newText, Word.InsertLocation.replace);
                        }
                    }
                    
                    await context.sync();
                });
                showStatus("تم الاستبدال بنجاح!", "text-green-600");
                document.getElementById('btn-replace').disabled = true;
                document.getElementById('log-area').innerHTML += '<div class="text-center text-green-600 font-bold mt-2">✓ تم الانتهاء</div>';
            } catch (error) {
                console.error(error);
                showStatus("حدث خطأ أثناء الاستبدال: " + error.message, "text-red-600");
            }
        }

        function showStatus(msg, color) {
            const el = document.getElementById('status-bar');
            el.textContent = msg;
            el.className = `text-center text-xs h-4 transition-opacity font-medium ${color}`;
            el.style.opacity = 1;
        }
    </script>
</body>
</html>
